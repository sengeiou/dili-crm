<#body>

    <style>
        input{height: 18px;}
    </style>
    <div class="easyui-layout" style="margin-left: 20px;" fit="true">
        <div region="center" style="width:99%;" minHeight="360" border="false">
            <!-- 上方导航栏 (锁定不滚动) -->
            <div id="nav" style="padding-left:10px;padding-top:10px;position:fixed;z-index:2008;width:99%;height:30px;background-color:white" align="left">
                <#nav/>
                <div style="display: inline;float:right;padding-right: 300px;">
                    <%if (hasResource("editVisit") && has(edit)){%>
                        <a id="editBtn" href="#" class="easyui-linkbutton" iconCls="icon-edit" data-options="width:80" onclick="toEdit()">编辑</a>&nbsp;&nbsp;
                    <%}%>
                    <a id="cancelBtn" href="#" class="easyui-linkbutton" iconCls="icon-cancel" data-options="width:80" onclick="doBack()">取消</a>
                </div>
            </div>
            <div style="margin-top:50px">
                <div id="stateDiv" style="padding-left:10px;width:99%;display: none;">
                    <input id="stateValue"  style="width: 93%;height: 30px; background-color: lightgrey;border: hidden;text-align: center;font-size: large" value="" disabled="disabled">
                </div>
                <form id="_form" class="easyui-form" method="post" fit="true">
                    <input name="_id" id="_id" type="hidden">
                    <table width="99%" align="center">
                        <tr>
                            <td style="padding:5px;" width="33%">
                                <input class="easyui-textbox" name="_createdName" id="_createdName" style="width: 80%;" data-options="labelAlign:'right',cls:'noborder', readonly:true, label:'回访创建者:'"  editable="true"/>
                            </td>
                            <td style="padding:5px;"  width="33%">
                                <input class="easyui-textbox" name="_subject" id="_subject" style="width: 80%;" data-options="labelAlign:'right',cls:'noborder', readonly:true, editable:false,label:'主题:', validType:'length[0,40]'"  />
                            </td>
                            <td style="padding:5px;" width="33%">
                                <input class="easyui-textbox" name="userId" id="userId" panelWidth="auto" panelHeight="auto" label="回访人:" style="width: 80%;"
                                       data-options="labelAlign:'right',cls:'noborder', readonly:true, editable:false, hasDownArrow:false" />
                            </td>
                        </tr>
                        <tr>
                            <td style="padding:5px;">
                                <input class="easyui-textbox" name="customerId" id="customerId" panelWidth="auto" panelHeight="auto" label="回访客户:" style="width: 80%;"
                                       data-options="labelAlign:'right',cls:'noborder', readonly:true, editable:false" />
                            </td>
                            <td style="padding:5px;">
                                <input name="_mode" class="easyui-combobox" id="_mode" style="width:80%;" panelWidth="auto" panelHeight="auto" label="回访方式:" data-options="labelAlign:'right',cls:'noborder', readonly:true, editable:false, hasDownArrow:false"/>
                                <#comboProvider _id="_mode" _provider='dataDictionaryValueProvider' _queryParams='{dd_id:"11"}'/>
                            </td>
                            <td style="padding:5px;">
                                <input class="easyui-combobox" name="_priority" id="_priority" style="width:80%;" data-options="labelAlign:'right',cls:'noborder', readonly:true, editable:false, hasDownArrow:false" panelWidth="auto" panelHeight="auto" label="优先级:" />
                                <#comboProvider _id="_priority" _provider='dataDictionaryValueProvider' _queryParams='{dd_id:"10"}'/>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding:5px;">
                                <input class="easyui-datetimebox" name="_finishTime" id="_finishTime" style="width:80%" data-options="labelAlign:'right',label:'完成时间:',cls:'noborder', readonly:true, editable:false, hasDownArrow:false"/>
                            </td>
                            <td style="padding:5px;" >
                                <input class="easyui-textbox" name="_code" id="_code" style="width:80%"  data-options="labelAlign:'right',label:'回访编码:',cls:'noborder',readonly:true, editable:false" />
                            </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td style="padding:5px;" colspan="2">
                                <input class="easyui-textbox" name="_notes" id="_notes" style="width:90%" multiline="true" data-options="labelAlign:'right',label:'描述:', validType:'length[0,200]'" />
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
            <!--------------------事件信息------------------------>
            <div id="eventDiv" style="padding-left:10px;width: 99%;display: none;">
                <!-- =========================================================事件表格========================================================= -->
                <p />
                <table class="easyui-datagrid" id="eventGrid" style="height:auto;width: 93%;" title="事件" collapsible="true"
                       pagination="false" rownumbers="false" remoteSort="false"
                       loadMsg="数据加载中..." singleSelect="true" method="post" multiSort="false"
                       align="left"  striped="false" idField="id" >
                    <thead>
                    <tr>
                        <th width="20%" data-options="field:'time', _provider:'datetimeProvider', sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            时间
                        </th>
                        <th width="10%" data-options="field:'mode', _provider:'dataDictionaryValueProvider',_queryParams:{'dd_id':'11'},sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            方式
                        </th>
                        <th width="15%" data-options="field:'userId', _provider:'ownerProvider', sortable:'false', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            处理人
                        </th>
                        <th width="56%" data-options="field:'notes', sortable:'false', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            事件描述
                        </th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>


    <script type="text/javascript">
        /**
         * 打开编辑回访窗口
         */
        function toEdit(){
            var visitId = $("#_id").val();
            window.location.href="${contextPath}/customerVisit/edit.html?id="+visitId;
        }


        /**
         * 绑定页面回车事件，以及初始化页面时的光标定位
         * @formId
         *          表单ID
         * @elementName
         *          光标定位在指点表单元素的name属性的值
         * @submitFun
         *          表单提交需执行的任务
         */
        $(function () {
            <%if (has(customerVisit)){%>
                var selected = ${customerVisit};
                $('#_form').form('clear');
                var formData = $.extend({},selected);
                //设置客户所有者(这里表格中的提供者已经作了转义,只需要对应上字段即可)
                formData["createdName"] = selected["createdId"];
                formData = addKeyStartWith(getOriginalData(formData),"_");
                $('#_form').form('load', formData);
                $("#customerId").textbox("initValue", selected["customerId"]);
                $("#userId").textbox("initValue", selected["$_createdId"]);
                $("#userId").textbox("setText", selected["createdId"]);
                $("#eventDiv").show();
                $("#stateDiv").show();  //状态div
                $("#stateValue").val(selected["state"]);  //状态显示值
                listEvents();
            <%}else{%>

            <%}%>

        });



        /**
         * 加载事件信息列表
         */
        function listEvents(){
            var opts = $("#eventGrid").datagrid("options");
            if (null == opts.url || "" == opts.url) {
                opts.url = "${contextPath}/visitEvent/listPage";
            }
            //设置当前选择的回访id
            var visitId = $("#_id").val();
            if (typeof(visitId)=="undefined" || null == visitId || ""==visitId){
                $.messager.alert('错误','回访ID丢失，请返回列表后，重新操作！','error');
                return;
            }
            var param = bindMetadata("eventGrid", true);
            $.extend(param, {"customerVisitId":visitId});
            $("#eventGrid").datagrid("load", param);
        }

        /**
         * 返回按钮事件
         */
        function doBack() {
            window.location.href="${contextPath}/customerVisit/index.html";
        }
    </script>
</#body>