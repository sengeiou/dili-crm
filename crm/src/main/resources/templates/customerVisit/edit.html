<#body>
    <script>
        <#controls_user dlgId="userSelectDialog" controlId="userId"/>
        <#controls_customer dlgId="customerSelectDialog" controlId="customerId"/>
    </script>
    <div class="easyui-layout" style="margin-left: 20px;" fit="true">
        <div region="north" style="width: 99%;padding: 10px;">
            <table>
                <tr>
                    <td style="width: 30%;">
                        <strong>新建回访</strong>
                    </td>
                    <td align="right">
                        <a id="saveBtn" href="#" class="easyui-linkbutton" data-options="width:80" onclick="saveOrUpdate(1)">保存</a>&nbsp;&nbsp;
                        <a id="saveAndNewBtn" href="#" class="easyui-linkbutton" data-options="width:100" onclick="saveOrUpdate(2)">保存并新建</a>
                        <a id="saveAndFilishedBtn" href="#" class="easyui-linkbutton" data-options="width:100" onclick="saveOrUpdate(3)">保存并完成</a>&nbsp;&nbsp;
                        <a id="cancelBtn" href="#" class="easyui-linkbutton" data-options="width:80" onclick="Javascript:history.back();">取消</a>
                    </td>
                </tr>
            </table>
        </div>
        <div region="center" style="width:100%;" minHeight="360" border="false">
            <div id="userSelectDialog" style="display: none;"></div>
            <div id="customerSelectDialog" style="display: none;"></div>
            <form id="_form" class="easyui-form" method="post" fit="true">
                <input name="_id" id="_id" type="hidden">
                <table width="99%">
                    <tr>
                        <td style="padding:5px;">
                            <input class="easyui-textbox" name="_createdName" id="_createdName" style="width:30%" data-options="label:'回访创建者:'" disabled="true" editable="false"/>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:5px;">
                            <input class="easyui-textbox" name="userId" id="userId" panelWidth="auto" panelHeight="auto" label="回访人:" style="width: 30%;" required="true"
                                   data-options="editable:false,buttonText:'选择',onClickButton:_selectUser" />
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:5px;">
                            <input class="easyui-textbox" name="customerId" id="customerId" panelWidth="auto" panelHeight="auto" label="回访对象:" style="width: 30%;" required="true"
                                   data-options="editable:false,
									buttonText:'选择',
									onClickButton:_selectCustomer,onChange:_changeTextboxShowClear" />
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:5px;">
                            <input class="easyui-textbox" name="_subject" id="_subject" style="width:30%" data-options="label:'主题:', validType:'length[0,40]'" required="true" />
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:5px;">
                            <input name="_mode" id="_mode" style="width:30%;" panelWidth="auto" panelHeight="auto" label="回访方式:" required="true" editable="false"/>
                            <#comboProvider _id="_mode" _provider='dataDictionaryValueProvider' _queryParams='{dd_id:"11"}'/>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:5px;">
                            <input name="_priority" id="_priority" style="width:30%;" data-options="editable:false" panelWidth="auto" panelHeight="auto" label="优先级:" required="true" />
                            <#comboProvider _id="_priority" _provider='dataDictionaryValueProvider' _queryParams='{dd_id:"10"}'/>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:5px;">
                            <input class="easyui-datetimebox" name="_finishTime" id="_finishTime" style="width:30%" data-options="label:'完成时间:'"
                                   required="true" />
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:5px;">
                            <input class="easyui-textbox" name="_notes" id="_notes" style="width:30%" data-options="label:'描述:', validType:'length[0,200]'" />
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>

    <script type="text/javascript">
        //打开修改客户窗口
        function openUpdate(){
            <%if (has(customerVisit)){%>
            var selected = ${customerVisit};
            <%}else{%>
            var selected = null;
            <%}%>
            if (null == selected) {
                $.messager.alert('警告','请指定一条数据');
                return;
            }
            $('#_form').form('clear');
            var formData = $.extend({},selected);
            //设置客户所有者(这里表格中的提供者已经作了转义,只需要对应上字段即可)
            formData["createdName"] = selected["createdId"];
            formData["userName"] = selected["userId"];
            formData["customerName"] = selected["customerId"];
            formData = addKeyStartWith(getOriginalData(formData),"_");
            $('#_form').form('load', formData);
            formFocus("_form", "_userName");
        }

        //打开新增客户窗口
        function openInsert(){
            $('#_form').form('clear');
      //      $("#_createdName").textbox("setValue", "${user.realName}");
            $("#userId").textbox("setValue", 1);
            $("#userId").textbox("setText", "${user.realName}");
//            formFocus("_form", "_userName");
        }

        //全局按键事件
        function getKey(e){
            e = e || window.event;
            var keycode = e.which ? e.which : e.keyCode;
            if(keycode == 46){ //如果按下删除键
                var selected = $("#grid").treegrid("getSelected");
                if(selected && selected!= null){
                    del();
                }
            }
        }

        /**
         * 绑定页面回车事件，以及初始化页面时的光标定位
         * @formId
         *          表单ID
         * @elementName
         *          光标定位在指点表单元素的name属性的值
         * @submitFun
         *          表单提交需执行的任务
         */
        $(function () {
//            bindFormEvent("_form", "_userId");
//            if (document.addEventListener) {
//                document.addEventListener("keyup",getKey,false);
//            } else if (document.attachEvent) {
//                document.attachEvent("onkeyup",getKey);
//            } else {
//                document.onkeyup = getKey;
//            }
            

//            if(location.hash=='#update'){
//                openUpdate();
//            }
           // else if(location.hash=='#insert'){
//                openInsert();
           // }
            $('#_form').form('clear');
            $("#userId").textbox("setValue", 1);
            $("#userId").textbox("setText", "${user.realName}");
        });

        //保存回访信息
        function saveOrUpdate(type){    alert($("#userId").textbox("getValue"));return;
            if(!$('#_form').form("validate")){
                return;
            }

            $.messager.confirm('确认','您确认想要保存吗？',function(r) {
                if (r) {
//                    $("#saveBtn").linkbutton("disable");
                    alert("getValue:"+$("#userId").textbox("getValue"));
                    var _formData = removeKeyStartWith($("#_form").serializeObject(),"_");

                    alert(JSON.stringify(_formData));
                    return;
                    var _url = null;
                    //没有id就新增
                    if(_formData.id == null || _formData.id==""){
                        _url = "${contextPath}/customerVisit/insert";
                    }else{//有id就修改
                        _url = "${contextPath}/customerVisit/update";
                    }
                    $.ajax({
                        type: "POST",
                        url: _url,
                        data: _formData,
                        processData:true,
                        dataType: "json",
                        async : true,
                        success: function (data) {
                            if(data.code=="200"){
                                window.location.href="${contextPath}/customerVisit/index.html";
                            }else{
                                $.messager.alert('错误',data.result,'error');
                            }
                        },
                        error: function(){
                            $.messager.alert('错误','远程访问失败','error');
                        }
                    });
                }
            });
        }

        function change() {
            alert("changed");
        }

    </script>
</#body>