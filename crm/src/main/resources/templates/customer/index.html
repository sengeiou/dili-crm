 <#body>
    <div class="easyui-layout" fit="true">

        <!-- ====================================================================================================================== -->
        <!-- 上方布局 -->
        <!-- ====================================================================================================================== -->
        <div region="north" height="auto" align="center" border="false">
            <div id="nav" style="padding-left:15px;padding-top:10px;" align="left">
            <#nav/>
            </div>
            <!-- =========================================================表单========================================================= -->
            <div class="easyui-panel" style="width:100%;border: 0px;" align="left" border="false">
                <form id="form" class="easyui-form" method="post" fit="true">
                    <table style="padding:10px;">
                        <tr>
                            <td style="padding:10px;">
                                <input class="easyui-textbox" name="name" id="name" style="width:100%" data-options="label:'客户名称:', labelAlign:'right', validType:'length[0,40]'" />
                            </td>
                            <td style="padding:10px;">
                                <input class="easyui-textbox" name="code" id="code" style="width:100%" data-options="label:'客户编码:', labelAlign:'right', validType:'length[0,40]'" />
                            </td>
                            <td style="padding:10px;">
                                <input class="easyui-textbox" name="certificateNumber" id="certificateNumber" style="width:100%" data-options="label:'证件号:', labelAlign:'right', validType:'length[0,40]'" />
                            </td>
                            <td style="padding:10px;">
                                <input name="type" id="type" style="width:100%;" panelWidth="auto" data-options="editable:false, labelAlign:'right'" panelHeight="auto" label="客户类型:"/>
                                <#comboProvider _id="type" _provider='dataDictionaryValueProvider' _queryParams='{dd_id:"4"}'/>
                            </td>
                        </tr>
                        <tr>

                            <td style="padding:10px;">
                                <input name="profession" id="profession" style="width:100%;" data-options="labelAlign:'right', editable:false" panelWidth="auto" panelHeight="auto" label="客户行业:"/>
                                <#comboProvider _id="profession" _provider='dataDictionaryValueProvider' _queryParams='{dd_id:"6"}'/>

                            </td>
                            <td style="padding:10px;">
                                    <input name="market" id="market" style="width:100%;" data-options="labelAlign:'right', editable:false" panelWidth="auto" panelHeight="auto" label="所属市场:"/>
                                    <#comboProvider _id="market" _provider='dataDictionaryValueProvider' _queryParams='{dd_id:"2"}'/>
                            </td>
                            <td style="padding:10px;">
                                <input name="organizationType" id="organizationType" style="width:100%;" data-options="labelAlign:'right', editable:false" panelWidth="auto" panelHeight="auto" label="组织类型:"/>
                                <#comboProvider _id="organizationType" _provider='dataDictionaryValueProvider' _queryParams='{dd_id:"5"}'/>

                            </td>
                            <td style="padding-left:28px;padding-top: 10px; padding-bottom: 10px;">
                                <a href="#" class="easyui-linkbutton" id="queryBtn" data-options="width:80" iconCls="icon-search"
                                   onclick="queryGrid()">查询</a>&nbsp;&nbsp;
                                <a href="javascript:void(0)" class="easyui-linkbutton" data-options="width:80" iconCls="icon-clear" onclick="clearForm()">清除</a>

                            </td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
        <!-- ====================================================================================================================== -->
        <!-- 中央布局 -->
        <!-- ====================================================================================================================== -->
        <!-- 表格 -->
        <div region="center"  height="auto" align="center" border="false">
            <div class="easyui-panel" align="center" style="width:96%;height:100%;" border="false">
            <!-- =========================================================表格========================================================= -->
            <table class="easyui-treegrid" id="grid" fitColumns="true"  title="客户信息" noheader="true"
                   pagination="true" pageSize="30" pageNumber="1" pagePosition="top" remoteSort="true"
                   loadMsg="数据加载中..." singleSelect="true" method="post" multiSort="false" sortName="created" sortOrder="desc"
                   align="center" fit="true" striped="true"
                   data-options="onDblClickRow:<%if(hasResource("updateCustomer")) {%>openUpdate,<%}else{%>openDetail,<%}%>
                   onHeaderContextMenu:headerContextMenu,
                   onBeforeExpand:onBeforeExpand,
                   autoRowHeight:false,
                   onLoadSuccess:onLoadSuccess,
                   idField:'id',
                   treeField: 'name',
                    _parentIdField:'parentId',
                    loadFilter:treegridLoadFilter">
                <thead>
                    <tr>
                        <th data-options="field:'name',   sortable:'true', order:'asc', align:'left', resizable:'true', fixed:'false'">
                            名称
                        </th>
                        </th>
                        <th data-options="field:'code',   sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            编码
                        </th>
                        <th data-options="field:'ownerId', _provider:'ownerProvider', sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            所有者
                        </th>
                        <th data-options="field:'certificateNumber',   sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            证件号
                        </th>
                        <th data-options="field:'certificateType', _provider:'dataDictionaryValueProvider', _queryParams:{'dd_id':'3'}, sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            证件类型
                        </th>
                        <th data-options="field:'phone', sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            电话
                        </th>
                        <th data-options="field:'organizationType', _provider:'dataDictionaryValueProvider', _queryParams:{'dd_id':'5'},  sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            组织类型
                        </th>
                        <th data-options="field:'sourceSystem', _provider:'dataDictionaryValueProvider', _queryParams:{'dd_id':'8'},  sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            来源系统
                        </th>
                        <th data-options="field:'department', _provider:'departmentProvider', sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            归属部门
                        </th>
                        <th data-options="field:'market', _provider:'dataDictionaryValueProvider', _queryParams:{'dd_id':'2'},  sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            所属市场
                        </th>
                        <th data-options="field:'type',  _provider:'dataDictionaryValueProvider', _queryParams:{'dd_id':'4'},  sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            客户类型
                        </th>
                        <th data-options="field:'profession',  _provider:'dataDictionaryValueProvider', _queryParams:{'dd_id':'6'},  sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            客户行业
                        </th>
                        <th data-options="field:'operatingArea', _provider:'cityProvider',  sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            经营地区
                        </th>
                        <th data-options="field:'mainCategory',   sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            主营品类
                        </th>
                        <th data-options="field:'created', _provider:'datetimeProvider',  sortable:'true', order:'asc', align:'center', resizable:'true', fixed:'false'">
                            创建时间
                        </th>
                    </tr>
                </thead>
            </table>
            </div>
        </div> <!-- end of region="center" -->
    </div>

    <!-- ====================================================================================================================== -->
    <!-- style & script 分隔线 -->
    <!-- ====================================================================================================================== -->
    <script type="text/javascript">

        // ============================   客户相关js st  ==============================

        //加载完了必须要重设url，否则删除的时候可能会调用expand
//        var onLoadSuccess = function(row, data) {
//            $(this).treegrid("options").url = "${contextPath}/customer/listPage";
//        }
        var onBeforeExpand = function(row,param){
            $("#grid").treegrid("options").url ="${contextPath}/customer/expand?parentId="+row.id;
        };

        // //打开新增子级客户窗口
        // function openChildInsert(){
        //     var selected = $("#grid").treegrid("getSelected");
        //     if (null == selected) {
        //         $.messager.alert('警告','请选中一条数据');
        //         return;
        //     }
        //     window.location.href="${contextPath}/customer/add.html?id="+selected["id"];
        // }

        //打开新增客户窗口
        function openInsert(){
            window.location.href="${contextPath}/customer/add.html";
        }

        //打开修改客户窗口
        function openUpdate(){
            <#resource code="updateCustomer">
                var selected = $("#grid").treegrid("getSelected");
                if (null == selected) {
                    $.messager.alert('警告','请选中一条数据');
                    return;
                }
                window.location.href="${contextPath}/customer/edit.html?id="+selected["id"];
            </#resource>
        }

        //打开修改客户窗口
        function openDetail(){
            <#resource code="viewCustomer">
                var selected = $("#grid").treegrid("getSelected");
                if (null == selected) {
                    $.messager.alert('警告','请选中一条数据');
                    return;
                }
                window.location.href="${contextPath}/customer/detail.html?id="+selected["id"];
            </#resource>
        }

        //根据主键删除客户
        function del() {
            var selected = $("#grid").treegrid("getSelected");
            if (null == selected) {
                $.messager.alert('警告','请选中一条数据');
                return;
            }
            $.messager.confirm('确认','您确认想要删除记录吗？',function(r){
                if (r){
                    $.ajax({
                        type: "POST",
                        url: "${contextPath}/customer/delete",
                        data: {id:selected.id},
                        processData:true,
                        dataType: "json",
                        async : true,
                        success: function (data) {
                            if(data.code=="200"){
                                $("#grid").treegrid("reload");
                                $('#dlg').dialog('close');
                            }else{
                                $.messager.alert('错误',data.result);
                            }
                        },
                        error: function(){
                            $.messager.alert('错误','远程访问失败');
                        }
                    });
                }
            });
        }

        //加载完了必须要重设url，否则删除的时候可能会调用expand
        var onLoadSuccess = function(row, data) {
            $(this).treegrid("options").url = "${contextPath}/customer/listPage";
        }
        //客户表格查询
        function queryGrid() {
            var opts = $("#grid").treegrid("options").url = "${contextPath}/customer/listPage";
            if(!$('#form').form("validate")){
                return;
            }
            $("#grid").treegrid("load", bindGridMeta2Form("grid", "form"));
        }


        //清空客户表单
        function clearForm() {
            $('#form').form('clear');
        }

        //表格表头右键菜单
        function headerContextMenu(e, field){
            e.preventDefault();
            if (!cmenu){
                createColumnMenu("grid");
            }
            cmenu.menu('show', {
                left:e.pageX,
                top:e.pageY
            });
        }

        // ============================   客户相关js end  ==============================

        <#loadingProgress/>
        //全局按键事件
        function getKey(e){
            e = e || window.event;
            var keycode = e.which ? e.which : e.keyCode;
            if(keycode == 46){ //如果按下删除键
                var selected = $("#grid").treegrid("getSelected");
                if(selected && selected!= null){
                    del();
                }
            }
        }

        /**
         * 绑定页面回车事件，以及初始化页面时的光标定位
         * @formId
         *          表单ID
         * @elementName
         *          光标定位在指点表单元素的name属性的值
         * @submitFun
         *          表单提交需执行的任务
         */
        $(function () {
            bindFormEvent("form", "name", queryGrid);
            if (document.addEventListener) {
                document.addEventListener("keyup",getKey,false);
            } else if (document.attachEvent) {
                document.attachEvent("onkeyup",getKey);
            } else {
                document.onkeyup = getKey;
            }
            var pager = $('#grid').treegrid('getPager');    // get the pager of treegrid
            pager.pagination({
                <#controls_paginationOpts/>
                ,buttons:[
                <#resource code="viewCustomer">
                    {
                        iconCls:'icon-detail',
                        text:'详情',
                            handler:function(){
                            openDetail();
                        }
                    },
                </#resource>
                <#resource code="insertCustomer">
                    {
                        iconCls:'icon-add',
                        text:'新增',
                        handler:function(){
                            openInsert();
                        }
                    },
                </#resource>
                <#resource code="updateCustomer">
                    {
                        iconCls:'icon-edit',
                        text:'修改',
                        handler:function(){
                            openUpdate();
                        }
                    },
                </#resource>
                <#resource code="deleteCustomer">
                    {
                        iconCls:'icon-remove',
                        text:'删除',
                        handler:function(){
                            del();
                        }
                    },
                </#resource>
                <#resource code="exportCustomer">
                    {
                        iconCls:'icon-export',
                        text:'导出',
                        handler:function(){
                            doExport('grid', true);
                        }
                    },
                </#resource>
                ]
            });
            //表格仅显示下边框
            $('#grid').datagrid('getPanel').removeClass('lines-both lines-no lines-right lines-bottom').addClass("lines-bottom");

            //打开页面时查询
            queryGrid();

        })
    </script>
</#body>