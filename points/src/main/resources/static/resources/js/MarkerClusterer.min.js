var BMapLib=window.BMapLib=BMapLib||{};!function(){function e(e){this._markerClusterer=e,this._map=e.getMap(),this._minClusterSize=e.getMinClusterSize(),this._isAverageCenter=e.isAverageCenter(),this._center=null,this._markers=[],this._gridBounds=null,this._isReal=!1,this._clusterMarker=new BMapLib.TextIconOverlay(this._center,this._markers.length,{styles:this._markerClusterer.getStyles()})}var t=function(e,t,s){t=r(t);var i=e.pointToPixel(t.getNorthEast()),a=e.pointToPixel(t.getSouthWest());i.x+=s,i.y-=s,a.x-=s,a.y+=s;var n=e.pixelToPoint(i),o=e.pixelToPoint(a);return new BMap.Bounds(o,n)},r=function(e){var t=s(e.getNorthEast().lng,-180,180),r=s(e.getSouthWest().lng,-180,180),i=s(e.getNorthEast().lat,-74,74),a=s(e.getSouthWest().lat,-74,74);return new BMap.Bounds(new BMap.Point(r,a),new BMap.Point(t,i))},s=function(e,t,r){return t&&(e=Math.max(e,t)),r&&(e=Math.min(e,r)),e},i=function(e){return"[object Array]"===Object.prototype.toString.call(e)},a=function(e,t){var r=-1;if(i(t))if(t.indexOf)r=t.indexOf(e);else for(var s,a=0;s=t[a];a++)if(s===e){r=a;break}return r},n=BMapLib.MarkerClusterer=function(e,t){if(e){this._map=e,this._markers=[],this._clusters=[];var r=t||{};this._gridSize=r.gridSize||60,this._maxZoom=r.maxZoom||18,this._minClusterSize=r.minClusterSize||2,this._isAverageCenter=!1,void 0!=r.isAverageCenter&&(this._isAverageCenter=r.isAverageCenter),this._styles=r.styles||[];var s=this;this._map.addEventListener("zoomend",function(){s._redraw()}),this._map.addEventListener("moveend",function(){s._redraw()});var a=r.markers;i(a)&&this.addMarkers(a)}};n.prototype.addMarkers=function(e){for(var t=0,r=e.length;r>t;t++)this._markers.push(e[t]),e[t].isInCluster=!1;this._createClusters()},n.prototype._pushMarkerTo=function(e){var t=a(e,this._markers);-1===t&&(e.isInCluster=!1,this._markers.push(e))},n.prototype.addMarker=function(e){this._pushMarkerTo(e),this._createClusters()},n.prototype._createClusters=function(){for(var r,s=null,i=this._map.getBounds(),a=null,n=t(this._map,i,this._gridSize),o=0;r=this._markers[o];o++)if(!r.isInCluster&&n.containsPoint(r.getPosition())){var u=4e6,h=null,_=this._markers[o].getLabel();r.getMap()&&this._map.removeOverlay(r),this._markers[o].setLabel(_),s=r.getPosition();for(var l,p=0;l=this._clusters[p];p++)if(a=l.getCenter(),a&&l.isMarkerInClusterBounds(r)){var m=Math.pow(2,a.lat-r.getPosition().lat)+Math.pow(2,a.lng-r.getPosition().lng);u>m&&(u=m,h=l)}if(h)r.isInCluster=!0,h._markers.push(r);else{var l=new e(this);l._center=r.getPosition(),l.updateGridBounds(),r.isInCluster=!0,l._markers.push(r),l._isReal=!0,this._clusters.push(l)}}for(var l,o=0;l=this._clusters[o];o++){var c=l._markers.length;if(c<l._minClusterSize)for(var p=0;p<l._minClusterSize;p++)this._map.addOverlay(l._markers[p]);else{for(var v=0;c>v;v++){var _=l._markers[v].getLabel();l._markers[v].getMap()&&l._map.removeOverlay(l._markers[v]),l._markers[v].setLabel(_)}this._map.addOverlay(l._clusterMarker),l.updateClusterMarker()}}},n.prototype._addToClosestCluster=function(t){var r=4e6,s=null;t.getPosition();for(var i,a=0;i=this._clusters[a];a++){var n=i.getCenter();if(n&&i.isMarkerInClusterBounds(t)){var o=this._map.getDistance(n,t.getPosition());r>o&&(r=o,s=i)}}if(s)s.addMarker(t);else{var i=new e(this);i.addMarker(t),this._clusters.push(i)}},n.prototype._clearLastClusters=function(){for(var e,t=0;e=this._clusters[t];t++)e.remove();this._clusters=[],this._removeMarkersFromCluster()},n.prototype._removeMarkersFromCluster=function(){for(var e,t=0;e=this._markers[t];t++)e.isInCluster=!1},n.prototype._removeMarkersFromMap=function(){for(var e,t=0;e=this._markers[t];t++){e.isInCluster=!1;var r=e.getLabel();this._map.removeOverlay(e),e.setLabel(r)}},n.prototype._removeMarker=function(e){var t=a(e,this._markers);if(-1===t)return!1;var r=e.getLabel();return this._map.removeOverlay(e),e.setLabel(r),this._markers.splice(t,1),!0},n.prototype.removeMarker=function(e){var t=this._removeMarker(e);return t&&(this._clearLastClusters(),this._createClusters()),t},n.prototype.removeMarkers=function(e){for(var t=!1,r=0;r<e.length;r++){var s=this._removeMarker(e[r]);t=t||s}return t&&(this._clearLastClusters(),this._createClusters()),t},n.prototype.clearMarkers=function(){this._clearLastClusters(),this._removeMarkersFromMap(),this._markers=[]},n.prototype._redraw=function(){this._clearLastClusters(),this._createClusters()},n.prototype.getGridSize=function(){return this._gridSize},n.prototype.setGridSize=function(e){this._gridSize=e,this._redraw()},n.prototype.getMaxZoom=function(){return this._maxZoom},n.prototype.setMaxZoom=function(e){this._maxZoom=e,this._redraw()},n.prototype.getStyles=function(){return this._styles},n.prototype.setStyles=function(e){this._styles=e,this._redraw()},n.prototype.getMinClusterSize=function(){return this._minClusterSize},n.prototype.setMinClusterSize=function(e){this._minClusterSize=e,this._redraw()},n.prototype.isAverageCenter=function(){return this._isAverageCenter},n.prototype.getMap=function(){return this._map},n.prototype.getMarkers=function(){return this._markers},n.prototype.getClustersCount=function(){for(var e,t=0,r=0;e=this._clusters[r];r++)e.isReal()&&t++;return t},e.prototype.addMarker=function(e){if(this.isMarkerInCluster(e))return!1;if(this._center){if(this._isAverageCenter){var t=this._markers.length+1,r=(this._center.lat*(t-1)+e.getPosition().lat)/t,s=(this._center.lng*(t-1)+e.getPosition().lng)/t;this._center=new BMap.Point(s,r),this.updateGridBounds()}}else this._center=e.getPosition(),this.updateGridBounds();e.isInCluster=!0,this._markers.push(e);var i=this._markers.length;if(i<this._minClusterSize)return this._map.addOverlay(e),!0;if(i===this._minClusterSize)for(var a=0;i>a;a++){var n=this._markers[a].getLabel();this._markers[a].getMap()&&this._map.removeOverlay(this._markers[a]),this._markers[a].setLabel(n)}return this._map.addOverlay(this._clusterMarker),this._isReal=!0,this.updateClusterMarker(),!0},e.prototype.isMarkerInCluster=function(e){if(this._markers.indexOf)return-1!=this._markers.indexOf(e);for(var t,r=0;t=this._markers[r];r++)if(t===e)return!0;return!1},e.prototype.isMarkerInClusterBounds=function(e){return this._gridBounds.containsPoint(e.getPosition())},e.prototype.isReal=function(){return this._isReal},e.prototype.updateGridBounds=function(){var e=new BMap.Bounds(this._center,this._center);this._gridBounds=t(this._map,e,this._markerClusterer.getGridSize())},e.prototype.updateClusterMarker=function(){if(this._map.getZoom()>this._markerClusterer.getMaxZoom()){this._clusterMarker&&this._map.removeOverlay(this._clusterMarker);for(var e,t=0;e=this._markers[t];t++)this._map.addOverlay(e)}else{if(this._markers.length<this._minClusterSize)return this._clusterMarker.hide(),void 0;this._clusterMarker.setPosition(this._center),this._clusterMarker.setText(this._markers.length);var r=this._map,s=this.getBounds();this._clusterMarker.addEventListener("click",function(){r.setViewport(s)})}},e.prototype.remove=function(){for(var e,t=0;e=this._markers[t];t++){var r=this._markers[t].getLabel();this._markers[t].getMap()&&this._map.removeOverlay(this._markers[t]),this._markers[t].setLabel(r)}this._map.removeOverlay(this._clusterMarker),this._markers.length=0,delete this._markers},e.prototype.getBounds=function(){for(var e,t=new BMap.Bounds(this._center,this._center),r=0;e=this._markers[r];r++)t.extend(e.getPosition());return t},e.prototype.getCenter=function(){return this._center}}();