<#body>
<style>
    input {
        height: 18px;
    }

    .inputWidth {
        width: 20%;
    }

    /*回访进度条*/
    #stateDiv {
        width: 100%;
        padding: 0;
    }

    #stateDiv .step {
        display: inline-block;
        width: 32%;
        height: 36px;
        line-height: 36px;
    }

    #stateDiv .step.cur {
        color: #fff;
    }

    #stateDiv .step:first-child {
        background: url(${contextPath}/resources/images/visitCus/step1.png) no-repeat left center;
        background-size: 100%;
    }

    #stateDiv .step:first-child.cur {
        background: url(${contextPath}/resources/images/visitCus/step1-hv.png) no-repeat left center;
        background-size: 100%;
    }

    #stateDiv .step:nth-child(2) {
        background: url(${contextPath}/resources/images/visitCus/step2.png) no-repeat left center;
        background-size: 100%;
    }

    #stateDiv .step:nth-child(2).cur {
        background: url(${contextPath}/resources/images/visitCus/step2-hv.png) no-repeat left center;
        background-size: 100%;
    }

    #stateDiv .step:last-child {
        background: url(${contextPath}/resources/images/visitCus/step3.png) no-repeat left center;
        background-size: 100%;
    }

    #stateDiv .step:last-child.cur {
        background: url(${contextPath}/resources/images/visitCus/step3-hv.png) no-repeat left center;
        background-size: 100%;

    }

</style>
<div class="easyui-layout" fit="true">
    <div id="userSelectDialog" style="display: none;"></div>
    <div id="customerSelectDialog" style="display: none;"></div>
    <div region="center" style="width:100%;" minHeight="360" align="center" border="false">
        <!-- 上方导航栏 (锁定不滚动) -->
        <div id="nav"
             style="padding-left:10px;padding-top:10px;position:fixed;z-index:2008;width:99%;height:30px;background-color:white"
             align="left">
            <div style="display: inline;float:right;padding-right: 40px;">
                <a id="saveBtn" href="#" class="easyui-linkbutton" iconCls="icon-save"
                   data-options="width:80" onclick="submitForm(this)">保存</a>
                <a id="cancelBtn" href="#" class="easyui-linkbutton" iconCls="icon-cancel" data-options="width:80"
                   onclick="doBack()">取消</a>
            </div>
        </div>
        <form id="_form" class="easyui-form" method="post" fit="true">
            <input type="hidden" name="numberJson" id="numberJson"/>
            <input type="hidden" name="moneyJson" id="moneyJson"/>
            <input type="hidden" name="payMethodJson" id="payMethodJson"/>
            <div align="center" style="margin-top:50px">
                <div class="easyui-panel" style="width: 94%;" title="积分基础信息" border="false">
                    <table align="center" width="94%">
                        <tr>
                            <td style="padding-top:10px;" width="25%">
                                <select class="easyui-combobox inputWidth" name="businessType" id="businessType"
                                        data-options="editable:false,labelAlign:'right',label:'交易类型:'">
                                    <option value="1">交易</option>
                                </select>
                            </td>
                            <td style="padding-top:10px;" width="25%">
                                <select class="easyui-combobox inputWidth" name="customerType" id="customerType"
                                        data-options="editable:false,labelAlign:'right',label:'客户类型:'">
                                    <option value="1">卖家</option>
                                </select>
                            </td>

                            <td style="padding-top:10px;padding-left:10px;" width="25%">
                                <input class="easyui-textbox inputWidth" name="name" id="name"
                                       data-options="labelAlign:'right',label:'&lowast;规则名称:', validType:'length[0,40]'"
                                       required="true"/>
                            </td>
                            <td style="padding-top:10px;padding-left:10px;" width="25%">
                                <input class="easyui-textbox inputWidth" name="code" id="code"
                                       panelWidth="auto" panelHeight="auto" label="&lowast;规则编码:" required="true"
                                       data-options="labelAlign:'right',validType:'length[0,40]'"/>
                            </td>

                        </tr>
                    </table>
                </div>
            </div>
            <div align="center" style="margin-top:50px">
                <div class="easyui-panel" style="width: 94%;" title="积分计算标准" border="false">

                    <table align="center" width="94%">
                        <tr>
                            <td style="padding-top:10px;" width="33%">
                                <select class="easyui-combobox inputWidth" name="computingStandard"
                                        id="computingStandard"
                                        data-options="editable:false,labelAlign:'right',label:'计算标准:'">
                                    <option value="2">交易</option>
                                </select>
                            </td>

                            <td style="padding-top:10px;padding-left:10px;" width="33%">
                                <input class="easyui-textbox inputWidth" name="computingParameter"
                                       id="computingParameter"
                                       data-options="labelAlign:'right',label:'&lowast;计算参数:', validType:'length[0,40]'"
                                       required="true"/>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </form>
        <div align="center" style="margin-top:50px">
            <div class="easyui-panel" style="width: 94%;" title="积分权重" border="false">
                <table class="easyui-datagrid" id="dg_0" title="交易量" style="width:100%;margin:20px 0;"
                       data-options="singleSelect:true,collapsible:false,method:'get',toolbar:toolbar">
                    <thead>
                    <tr>
                        <th data-options="field:'displayText',width:200">交易量（公斤）</th>
                        <th data-options="field:'weight',width:100">权重值</th>
                        <th data-options="field:'conditionType',width:100,hidden:true"></th>
                        <th data-options="field:'value',width:100,hidden:true"></th>
                        <th data-options="field:'startValue',width:100,hidden:true"></th>
                        <th data-options="field:'endValue',width:100,hidden:true"></th>
                    </tr>
                    </thead>
                </table>

                <table class="easyui-datagrid" id="dg_1" title="交易额" style="width:100%;margin:20px 0;"
                       data-options="singleSelect:true,collapsible:false,method:'get',toolbar:toolbarMoney">
                    <thead>
                    <tr>
                        <th data-options="field:'displayText',width:200">交易额（元）</th>
                        <th data-options="field:'weight',width:100">权重值</th>
                        <th data-options="field:'conditionType',width:100,hidden:true"></th>
                        <th data-options="field:'value',width:100,hidden:true"></th>
                        <th data-options="field:'startValue',width:100,hidden:true"></th>
                        <th data-options="field:'endValue',width:100,hidden:true"></th>
                    </tr>
                    </thead>
                </table>

                <table class="easyui-datagrid" id="dg_2" title="支付方式" style="width:100%;margin:20px 0;"
                       data-options="singleSelect:true,collapsible:false,method:'get',toolbar:toolbarPay">
                    <thead>
                    <tr>
                        <th data-options="field:'displayText',width:200">支付方式</th>
                        <th data-options="field:'weight',width:100">权重值</th>
                        <th data-options="field:'value',width:100,hidden:true"></th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="dlg" class="easyui-dialog" title="交易量权重" data-options="iconCls:'icon-save'" modal="true" closed="true"
     style="width:500px;height:230px;padding:10px">
    <form id="number_form" method="post" action="">
        <input type="hidden" id="type" value="0"/>
        <input type="hidden" id="edit_type" value="0"/>
        <table cellpadding="5" id="tb" style="width: 100%">
            <tr>
                <td><span style="display:inline-block;line-height: 26px">条件:</span></td>
                <td><select class="easyui-combobox inputWidth" name="conditionType" id="conditionType"
                            data-options="editable:false,labelAlign:'right'">
                    <option value="179">区间</option>
                    <option value="181">大于</option>
                </select></td>
            </tr>
            <tr id="number_179">
                <td><span style="display:inline-block;line-height: 26px">条件值:</span></td>
                <td>
                    <input type="text" style="width:100px" required="true" class="easyui-numberbox" name="startValue"
                           id="startValue"> - <input style="width:100px" required="true" type="text"
                                                     validType="big['#startValue']"
                                                     class="easyui-numberbox"
                                                     name="endValue" id="endValue">
                </td>
            </tr>
            <tr id="number_179_other">
                <td><span style="display:inline-block;line-height: 26px">条件值:</span></td>
                <td>
                    <input type="text" required="true" class="easyui-numberbox" id="value" name="value" value="">
                </td>
            </tr>
            <tr>
                <td><span style="display:inline-block;line-height: 26px">权重值:</span></td>
                <td>
                    <input type="text" required="true" id="weight" class="easyui-numberbox" name="weight"
                           style="float: left;margin-top: 6px">
                </td>
            </tr>
        </table>
    </form>
    <div style="text-align:center;padding:5px;">
        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="width:'80px'"
           onclick="saveNumber()">确定</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="width:'80px'"
           onclick="$('#dlg').dialog('close');">取消</a>
    </div>
</div>


<div id="dlg_pay" class="easyui-dialog" title="支付方式" data-options="iconCls:'icon-save'" closed="true"
     style="width:500px;height:200px;padding:10px">
    <form id="pay_form" method="post" action="">
        <input type="hidden" id="pay_edit_type" value="0"/>
        <table cellpadding="5" style="width: 100%">
            <tr>
                <td><span style="display:inline-block;line-height: 26px">支付方式:</span></td>
                <td><select class="easyui-combobox inputWidth" name="conditionType" id="payConditionType"
                            data-options="editable:false,labelAlign:'right'">
                    <option value="1">园区卡</option>
                    <option value="2">现金</option>
                </select></td>
            </tr>
            <tr>
                <td><span style="display:inline-block;line-height: 26px">权重值:</span></td>
                <td>
                    <input required="true" type="text" id="payWeight" class="easyui-numberbox" name="weight"
                           style="float: left;margin-top: 6px">
                </td>
            </tr>
        </table>
    </form>
    <div style="text-align:center;padding:5px;">
        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="width:'80px'"
           onclick="savePay()">确定</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="width:'80px'"
           onclick="$('#dlg_pay').dialog('close');">取消</a>
    </div>
</div>
<script type="text/javascript">
    var toolbar = [{
        text: '新增',
        iconCls: 'icon-add',
        handler: function () {
            $("#edit_type").val(0);
            $("#type").val(0);
            $('#dlg').dialog({
                title: '交易量权重（公斤）'
            });
            $('#dlg').dialog('open');
        }
    }, {
        text: '修改',
        iconCls: 'icon-edit',
        handler: function () {
            var row = $('#dg_0').datagrid('getSelected');
            if (null == row) {
                $.messager.alert('警告', '请选中一条数据');
                return;
            }
            $('#number_form').form('load', row);
            $("#edit_type").val(1);
            $("#type").val(0);
            $('#dlg').dialog({
                title: '交易量权重（公斤）'
            });
            $('#dlg').dialog('open');
        }
    }, {
        text: '删除',
        iconCls: 'icon-remove',
        handler: function () {
            var row = $('#dg_0').datagrid('getSelected');
            if (null == row) {
                $.messager.alert('警告', '请选中一条数据');
                return;
            }
            var index = $('#dg_0').datagrid('getRowIndex');
            $('#dg_0').datagrid('deleteRow', index);
        }
    }];


    var toolbarMoney = [{
        text: '新增',
        iconCls: 'icon-add',
        handler: function () {
            $("#edit_type").val(0);
            $("#type").val(1);
            $('#dlg').dialog({
                title: '交易额权重（元）'
            });
            $('#dlg').dialog('open');
        }
    }, {
        text: '修改',
        iconCls: 'icon-edit',
        handler: function () {
            var row = $('#dg_1').datagrid('getSelected');
            if (null == row) {
                $.messager.alert('警告', '请选中一条数据');
                return;
            }
            $('#number_form').form('load', row);
            $("#edit_type").val(1);
            $("#type").val(1);
            $('#dlg').dialog({
                title: '交易额权重（元）'
            });
            $('#dlg').dialog('open');
        }
    }, {
        text: '删除',
        iconCls: 'icon-remove',
        handler: function () {
            var row = $('#dg_1').datagrid('getSelected');
            if (null == row) {
                $.messager.alert('警告', '请选中一条数据');
                return;
            }
            var index = $('#dg_1').datagrid('getRowIndex');
            $('#dg_1').datagrid('deleteRow', index);
        }
    }];


    var toolbarPay = [{
        text: '新增',
        iconCls: 'icon-add',
        handler: function () {
            $("#pay_edit_type").val(0);
            $('#dlg_pay').dialog('open');
        }
    }, {
        text: '修改',
        iconCls: 'icon-edit',
        handler: function () {
            var row = $('#dg_2').datagrid('getSelected');
            if (null == row) {
                $.messager.alert('警告', '请选中一条数据');
                return;
            }
            $('#pay_form').form('load', row);
            $("#pay_edit_type").val(1);
            $('#dlg_pay').dialog('open');
        }
    }, {
        text: '删除',
        iconCls: 'icon-remove',
        handler: function () {
            var row = $('#dg_2').datagrid('getSelected');
            if (null == row) {
                $.messager.alert('警告', '请选中一条数据');
                return;
            }
            var index = $('#dg_2').datagrid('getRowIndex');
            $('#dg_2').datagrid('deleteRow', index);
        }
    }];

    function saveNumber() {
        if (!$("#number_form").form('validate')) {
            alert("没有");
            return;
        }
        var edit_type = $("#edit_type").val();
        var type = $("#type").val();
        var c_type = $("#conditionType").combobox("getValue");
        var value = $("#value").val();
        var start_value = $("#startValue").val();
        var end_value = $("#endValue").val();
        var weight = $("#weight").val();
        var displayText = "";
        if ($("#conditionType").combobox("getValue") == 179) {
            displayText = start_value + " - " + end_value;
        } else {
            displayText = $("#conditionType").combobox("getText") + value;
        }
        var dg = $("#dg_" + type);
        if (edit_type == 0) {
            dg.datagrid('appendRow', {
                conditionType: c_type,
                value: value,
                startValue: start_value,
                endValue: end_value,
                weight: weight,
                displayText: displayText
            });
        } else {
            var index = dg.datagrid('getRowIndex');
            dg.datagrid('updateRow', {
                index: index,
                row: {
                    conditionType: c_type,
                    value: value,
                    startValue: start_value,
                    endValue: end_value,
                    weight: weight,
                    displayText: displayText
                }
            });
        }
        $('#dlg').dialog('close');
        $('#number_form').form('clear');
    }


    function savePay() {
        var edit_type = $("#pay_edit_type").val();
        var value = $("#payConditionType").combobox("getValue");
        var weight = $("#payWeight").val();
        var displayText = $("#payConditionType").combobox("getText");
        var dg = $("#dg_2");
        if (edit_type == 0) {
            dg.datagrid('appendRow', {
                value: value,
                weight: weight,
                displayText: displayText
            });
        } else {
            var index = dg.datagrid('getRowIndex');
            dg.datagrid('updateRow', {
                index: index,
                row: {
                    value: value,
                    weight: weight,
                    displayText: displayText
                }
            });
        }
        $('#dlg_pay').dialog('close');
        $('#pay_form').form('clear');
    }

    function success() {
        var value = $("#conditionType").combobox("getValue");
        setDisplay(value);
    }

    function change(newValue) {
        setDisplay(newValue);
    }

    function setDisplay(value) {
        if (value == 179) {
            $("#number_179").show();
            $("#value").numberbox('disable');
            $("#startValue").numberbox('enable');
            $("#endValue").numberbox('enable');
            $("#number_179_other").hide();
        } else {
            $("#number_179").hide();
            $("#value").numberbox('enable');
            $("#startValue").numberbox('disable');
            $("#endValue").numberbox('disable');
            $("#number_179_other").show();
        }
    }

    function submitForm(obj) {
        $('#_form').form('submit', {
            url: "${contextPath}/pointsRule/insert",
            onSubmit: function () {
                if ($("#_form").form('validate')) {
                    $(obj).linkbutton('disable');
                }
                $("#numberJson").val(JSON.stringify($("#dg_0").datagrid("getData").rows));
                $("#moneyJson").val(JSON.stringify($("#dg_1").datagrid("getData").rows));
                $("#payMethodJson").val(JSON.stringify($("#dg_2").datagrid("getData").rows));
                return $("#_form").form('validate');
            },
            success: function (data) {

            }
        });
    }

    $.extend($.fn.validatebox.defaults.rules, {
        big: {
            validator: function (value, param) {
                return value > $(param[0]).val();
            },
            message: '必须大于起始值'
        }
    });

    $(function () {
        $('#conditionType').combobox({
            onLoadSuccess: function () {
                success();
            },
            onChange: function (newValue) {
                change(newValue)
            }
        });
    });
</script>
</#body>